# TODO APP

## Description
This is a simple todo app that allows you to add, delete and mark tasks as done.


## Database tips
To reset the database anytime

```bash
dropdb todoapp && createdb todoapp
```


## Migrations
Install Flask-Migrate dependencies:

  ```bash
  pip3 install Flask-Migrate
  ```

Import in app.py file.
Then, create an instance:

  ```python
  from flask_migrate import Migrate
  migrate = Migrate(app, db)
  ```

To create a migration:

  ```bash
  flask db init
  ```

It creates a migrations folder in the project root directory. This folder contain a version table and a migrations.

Before to create migration:

  ```bash
  dropdb todoapp && createdb todoapp
  ```

To create a migration:

  ```bash
  flask db migrate -m "migration message"
  #or without custom message
  flask db migrate
  ```


To apply the migration:

  ```bash
  flask db upgrade
  ```

To downgrade the migration:
  
  ```bash
  flask db downgrade
  ```

An example, we update `todo` table adding a new column.
We need to create a new migration:

  ```bash
  flask db migrate -m "Add  new column to todo table"
  ```

Then, apply the migration:

  ```bash
  flask db upgrade
  ```

## Working whith existing data

   ```bash
  flask db downgrade
  ```

The 'Completed' column (The new column) was deleted and now we insert new data.

Insert data into the database, we can use the following command:

  ```bash
  psql todoapp < data.sql
  ```
  Manually:

  ```sql
  INSERT INTO todos (description) VALUES ('This is todo');
  INSERT INTO todos (description) VALUES ('This is todo 2');
  INSERT INTO todos (description) VALUES ('This is todo 3');
```

If we run `flask db upgrade` again a not null violation error should be displayed, because we set as nullable=False the new column.
To fix this, we need to change the column to nullable=True (migration file) and then run `flask db upgrade`.

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('todos', schema=None) as batch_op:
        batch_op.add_column(sa.Column('completed', sa.Boolean(), nullable=True))
    # And add the following
        op.execute("UPDATE todos SET completed = False WHERE completed IS NULL")

        op.alter_column('todos', 'completed', nullable=False)
```

Then, run `flask db upgrade` again.

## Create relationship

We need to create a new table called `todolists` and a relationship between `todos` and `todolists` tables.
We will use the `todolists` table to store the lists of todos.
We will use the `todos` table to store the todos.

In the parent table we add a relationship column that refer to child table.
  
  ```python
  class TodoList(db.Model):
    ...
    todos = db.relationship('Todo', backref='todolist', lazy=True)
  ```
  Where:
  - `Todo` is the child table.
  - `todolist` is the backref name.
  - `lazy=True` means that the relationship is not loaded by default.

In the child table we add a column that refer to parent table.

  ```python
  class Todo(db.Model):
    ...
    todolist_id = db.Column(db.Integer, db.ForeignKey('todolists.id'), nullable=False)
  ```
  Where:
  - `todolist_id` is the column that refer to the parent table.
  - `todolists.id` is the parent table and the column that we refer to.

We run migration to detect the changes:

  ```bash
  flask db migrate 
  ```

Then, we apply the migration:

  ```bash
  flask db upgrade
  ```

But, we receive an error message:
  
    ```bash
    [SQL: ALTER TABLE todos ADD COLUMN list_id INTEGER NOT NULL]
    ```

To fix this, we need to change the nullable=False to nullable=True in the migration file until can update all existing records.
  
    ```python
    def upgrade():
      # ### commands auto generated by Alembic - please adjust! ###
      ...
          batch_op.add_column(sa.Column('todolist_id', sa.Integer(), nullable=True))
      # ### end Alembic commands ###
    ```
  And we also change the todo class:
    
  ```python
  class Todo(db.Model):
    ...
    todolist_id = db.Column(db.Integer, db.ForeignKey('todolists.id'), nullable=True)
  ```

  Then, we run the migration again:
  
    ```bash
    flask db upgrade
    ```

Now we can do one of two things:
1. We can update the existing records to have a value in the `todolist_id` column.
2. We can change the `nullable=True` to `nullable=False` in the migration file and run the migration again.


We use the first option:

  ```sql
  INSERT into todolists (name) values ('Uncategorized');
  UPDATE todos SET list_id = 1 WHERE list_id IS NULL;
  ```

Then, we change the `nullable=True` to `nullable=False` in the todo class:


  ```python
  class Todo(db.Model):
    ...
    todolist_id = db.Column(db.Integer, db.ForeignKey('todolists.id'), nullable=False)
  ```

  Then, we run the migration again:
  
    ```bash
    flask db migration
    flask db upgrade
    ```